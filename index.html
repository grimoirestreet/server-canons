<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grimoire Street • Server Canons</title>
<style>
  :root{
    --bg:#15181d; --panel:#1e232a; --ink:#eef0f3; --muted:#aab0ba;
    --line:#282d35; --accent:#d3ba7c; --pill:#262b33;
  }
  html,body{background:var(--bg); color:var(--ink); margin:0}
  body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; line-height:1.55}
  .wrap{max-width:1100px; margin:24px auto; padding:0 16px}
  h1{margin:0 0 6px; font-size:clamp(26px,3.2vw,38px); color:var(--accent)}
  .sub{color:var(--muted); font-size:14px}
  .rule{height:1px; background:var(--line); margin:14px 0 18px}
  .toolbar{display:grid; grid-template-columns:1fr 220px 180px; gap:10px; align-items:center}
  @media (max-width:900px){.toolbar{grid-template-columns:1fr 1fr}}
  .input, select{width:100%; background:#1b1f25; color:var(--ink); border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:14px}
  .panel{background:var(--panel); border:1px solid var(--line); border-radius:14px; overflow:hidden}
  .list{display:block}
  details.item{border-bottom:1px solid var(--line)}
  summary{list-style:none; cursor:pointer; padding:12px 14px; display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center}
  summary::-webkit-details-marker{display:none}
  .name{font-weight:700}
  .meta{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .pill{display:inline-block; padding:3px 8px; border-radius:999px; background:var(--pill); border:1px solid var(--line); font-size:12px; color:#d9dde6}
  .body{padding:10px 14px 16px}
  .label{font-size:12px; color:#c9ced8; margin-top:6px}
  .empty{padding:16px; color:#cfd5de}
  .helper{margin-top:10px; font-size:12px; color:var(--muted)}
  a{color:var(--accent)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Grimoire Street • Server Canons</h1>
    <div class="sub">Single JSON file your staff can edit. Search + filter below.</div>
  </header>
  <div class="rule"></div>

  <section class="toolbar">
    <input id="q" class="input" placeholder="Search canons (title, text, notes…)" />
    <select id="type">
      <option value="">All types</option>
      <option>Rules</option>
      <option>Magic</option>
      <option>Location</option>
      <option>General</option>
    </select>
    <div class="helper">
      <a id="editLink" target="_blank" rel="noopener">Edit lore-data.json</a>
    </div>
  </section>

  <div style="height:12px"></div>

  <main class="panel">
    <section id="list" class="list">
      <div class="empty">Loading canons…</div>
    </section>
  </main>

  <p class="helper">Tip: After editing JSON, hard refresh (Ctrl/Cmd+Shift+R).</p>
</div>

<script>
const DATA_URL = 'lore-data.json'; // root file (no leading slash)
const EDIT_DATA_URL = 'https://github.com/grimoirestreet/server-canons/edit/main/lore-data.json';
document.getElementById('editLink').href = EDIT_DATA_URL;

// Debug: show the exact URL being fetched (helps if something 404s)
console.log('Fetching', new URL(DATA_URL, location.href).href);

const $ = s => document.querySelector(s);
const listEl = $('#list');

let CANONS = []; // {type, location, creator, lore, notes}

function matches(entry, state){
  if(state.type && entry.type !== state.type) return false;
  if(state.q){
    const blob = [
      entry.type, entry.location, entry.creator,
      entry.lore, entry.notes
    ].filter(Boolean).join(' ').toLowerCase();
    if(!blob.includes(state.q)) return false;
  }
  return true;
}

function makeRow(entry){
  const el = document.createElement('details');
  el.className = 'item';
  const sum = document.createElement('summary');

  const left = document.createElement('div');
  const name = document.createElement('div'); name.className='name'; name.textContent = entry.location || '(Untitled)';
  const preview = document.createElement('div'); preview.style.cssText='color:#aab0ba;font-size:13px;margin-top:2px';
  const text = (entry.lore || '').replace(/\s+/g,' ').trim();
  preview.textContent = text.slice(0,140) + (text.length>140?'…':'');
  left.append(name, preview);

  const meta = document.createElement('div'); meta.className='meta';
  const pType = document.createElement('span'); pType.className='pill'; pType.textContent = entry.type || '—';
  const pCreator = document.createElement('span'); pCreator.className='pill'; pCreator.textContent = entry.creator || '—';
  meta.append(pType, pCreator);

  sum.append(left, meta);

  const body = document.createElement('div'); body.className='body';
  const lore = document.createElement('div'); lore.innerHTML = (entry.lore || '').replace(/\n/g,'<br>');
  const notes = document.createElement('div'); notes.className='label';
  notes.textContent = entry.notes ? ('Notes: ' + entry.notes) : '';
  body.append(lore, notes);

  el.append(sum, body);
  return el;
}

function render(state){
  const items = CANONS.filter(c => matches(c, state));
  listEl.innerHTML = '';
  if(!items.length){
    const d = document.createElement('div'); d.className='empty'; d.textContent='No entries. Edit lore-data.json or loosen filters.';
    listEl.append(d); return;
  }
  items.forEach(c => listEl.append(makeRow(c)));
}

const state = { q:'', type:'' };
$('#q').addEventListener('input', e=>{ state.q = e.target.value.trim().toLowerCase(); render(state); });
$('#type').addEventListener('change', e=>{ state.type = e.target.value; render(state); });

(async function boot(){
  try{
    const res = await fetch(DATA_URL, { cache: 'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();

    CANONS = Array.isArray(data) ? data : (data.canons || []);
    if(!Array.isArray(CANONS)) throw new Error('JSON shape must be an array or { "canons": [] }');

    render(state);
  }catch(err){
    listEl.innerHTML = '<div class="empty">Could not load <code>'+DATA_URL+'</code> – check GitHub Pages is enabled and JSON is valid.<br><small>'+String(err)+'</small></div>';
  }
})();
</script>
</body>
</html>
